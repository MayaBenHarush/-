<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>החנות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- אם יש לך styles.css כפי שבנית קודם -->
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    /* מינימום כדי לעבוד גם בלי styles.css */
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    nav { display:flex; gap:12px; margin-bottom:16px; }
    nav a, nav button { border:1px solid #ccc; padding:6px 10px; border-radius:6px; background:#f5f5f5; text-decoration:none; color:inherit; cursor:pointer; }
    #search { margin: 12px 0 20px; width: 260px; }
    #products { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:16px; }
    .product { border:1px solid #ccc; border-radius:6px; padding:10px; background:#fafafa; }
    .product img { width:100%; height:auto; display:block; }
    .product h3 { margin:8px 0 6px; font-size:18px; }
    .product p { margin:0 0 10px; color:#555; font-size:14px; }
  </style>
</head>
<body>
  <nav>
    <a href="store.html">החנות</a>
    <a href="cart.html">סל הקניות</a>
    <a href="checkout.html">תשלום</a>
    <a href="myitems.html">הרכישות שלי</a>
    <a href="login.html">התחברות</a>
    <a href="admin.html">ניהול</a>

  </nav>

  <h1>חנות קינוחים 🍰</h1>

  <input id="search" type="text" placeholder="חפש קינוח..." />

  <div id="products"></div>

  <script>
    // טעינת מוצרים + חיפוש
    document.getElementById('search').addEventListener('input', fetchAndRender);

    async function fetchAndRender() {
      const prefix = document.getElementById('search').value || '';
      const res = await fetch(`/api/products?search=${encodeURIComponent(prefix)}`);
      const products = await res.json();

      const container = document.getElementById('products');
      container.innerHTML = '';

      for (const p of products) {
        const card = document.createElement('div');
        card.className = 'product';
        card.innerHTML = `
          <img src="/images/${p.image}" alt="${p.title}">
          <h3>${p.title}</h3>
          <p>${p.description || ''}</p>
          <button class="add-to-cart" data-id="${p.id}">Add to cart</button>
        `;
        container.appendChild(card);
      }
    }

    // האזנה ללחיצה על "Add to cart" (האצלת אירועים על הקונטיינר)
    document.getElementById('products').addEventListener('click', async (e) => {
      const btn = e.target.closest('button.add-to-cart');
      if (!btn) return;

      const id = btn.dataset.id;
      if (!id) {
        alert('Missing product id');
        return;
      }

      const res = await fetch('/api/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId: id })
      });

      if (res.status === 401) {
        // לא מחובר/ת – עוברים להתחברות
        location.href = 'login.html';
        return;
      }

      const payload = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert(payload.error || 'Failed to add to cart');
        return;
      }

      alert('✅ המוצר התווסף לסל!');
    });

    // טעינה ראשונית
    fetchAndRender();
  </script>
</body>
</html>
