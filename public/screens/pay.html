<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>Pay – תשלום</title>
  <link rel="stylesheet" href="/assets/styles.css">

</head>
<body>

    <nav>
    <a href="store.html">חנות</a>
    <a href="cart.html">סל הקניות</a>
    <a href="checkout.html">תשלום</a>
    <a href="myitems.html">הרכישות שלי</a>
    <button id="logout">התנתקות</button>
    <a href="admin.html">ניהול</a>

    </nav>


  <h1> תשלום ההזמנה שלי</h1>
  <p class="hint">זהו תשלום מדומה לצרכי תרגול בלבד — אין שמירה של פרטי כרטיס.</p>
  
  <form id="pay-form" novalidate>
    <label>
        שם בעל/ת הכרטיס
        <input type="text" name="cardName" autocomplete="cc-name" required />
    </label>

    <label>
        מספר הכרטיס
        <input type="text" name="cardNumber" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456" required />
    </label>

    <div class="row">
      <label>
        תוקף (MM/YY)
        <input type="text" name="expiry" inputmode="numeric" autocomplete="cc-exp" placeholder="12/27" required />
      </label>

      <label>
        CVV
        <input type="text" name="cvv" inputmode="numeric" autocomplete="cc-csc" placeholder="123" required />
      </label>
    </div>

    <div class="error" id="err"></div>

    <button id="pay-btn" type="submit">Pay</button>
    

  </form>

    <script>
    console.log('PAY page loaded');

    // Logout
    document.getElementById('logout').onclick = async () => {
      try {
        await fetch('/api/logout', { method: 'POST' });
      } finally {
        location.href = 'login.html';
      }
    };

    const form = document.getElementById('pay-form');
    const errBox = document.getElementById('err');
    const payBtn = document.getElementById('pay-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errBox.style.display = 'none';
      errBox.textContent = '';

      const cardName = form.cardName.value.trim();
      const rawNumber = form.cardNumber.value.trim();
      const cardNumber = rawNumber.replace(/[\s-]/g, ''); // הסרת רווחים/מקפים
      const expiry = form.expiry.value.trim();
      const cvv = form.cvv.value.trim();

      // ולידציה בסיסית בצד לקוח
      if (!cardName) return showErr('נא למלא שם בעל/ת הכרטיס');
      if (!/^\d{12,19}$/.test(cardNumber)) return showErr('מספר כרטיס לא תקין (לפחות 12 ספרות)');
      if (!/^\d{2}\/\d{2}$/.test(expiry)) return showErr('פורמט תוקף לא תקין (MM/YY)');
      const parts = expiry.split('/');
      const mm = parseInt(parts[0], 10), yy = parseInt(parts[1], 10);
      if (mm < 1 || mm > 12) return showErr('חודש תוקף לא תקין');
      if (!/^\d{3,4}$/.test(cvv)) return showErr('CVV לא תקין');

      // שליחה לשרת
      payBtn.disabled = true;
      payBtn.textContent = 'מעבד תשלום...';
      try {
        const res = await fetch('/api/pay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cardName, cardNumber, expiry, cvv })
        });

        if (res.status === 401) {
          // לא מחובר/ת
          location.href = 'login.html';
          return;
        }

        let payload = {};
        try { payload = await res.json(); } catch {}

        if (res.ok && payload && payload.ok) {
          location.href = 'thankyou.html';
        } else {
          showErr(payload && payload.error ? payload.error : 'Payment failed');
        }
      } catch (err) {
        showErr('שגיאת רשת — נסו שוב');
      } finally {
        payBtn.disabled = false;
        payBtn.textContent = 'Pay';
      }
    });

    function showErr(msg) {
      errBox.textContent = msg;
      errBox.style.display = 'block';
    }
  </script>
</body>
</html>