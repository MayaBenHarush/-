<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>מסך ניהול</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css">
  <style>
    .admin-grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media (max-width:900px){ .admin-grid{ grid-template-columns:1fr; } }
    .panel{ border:1px solid #eee; border-radius:10px; padding:14px; background:#fff; }
    .panel h2{ margin-top:0; }
    .admin-list{ display:flex; flex-direction:column; gap:10px; }
    .admin-row{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px; border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; }
    .admin-row img{ width:64px; height:64px; object-fit:cover; border-radius:6px; }
    .admin-row button{ border:1px solid #ccc; background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .admin-row button:hover{ background:#f2f2f2; }
    .admin-form label{ display:block; margin-bottom:10px; }
    .admin-form input, .admin-form textarea{ width:100%; box-sizing:border-box; padding:8px; border:1px solid #ccc; border-radius:8px; }
    .muted{ color:#666; font-size:12px; }
  </style>
</head>
<body>
  <nav>
    <a href="store.html">חנות</a>
    <a href="cart.html">סל הקניות</a>
    <a href="checkout.html">תשלום</a>
    <a href="myitems.html">הרכישות שלי</a>
    <a id="login-link" href="login.html">התחברות</a>
    <button id="logout" style="display:none">התנתקות</button>
    <a href="admin.html">ניהול</a>
  </nav>

  <h1>מסך ניהול</h1>

  <div class="admin-grid">
    <section class="panel">
      <h2>הוספת מוצר חדש</h2>
      <form id="add-form" class="admin-form">
        <label>כותרת המוצר <input type="text" name="title" required></label>
        <label>תיאור (אופציונלי) <textarea name="description" rows="3"></textarea></label>
        <label>תמונה (שם קובץ מתוך /public/images או URL מלא)
          <input type="text" name="image" placeholder="cookie.jpg או https://…" required>
        </label>
        <button type="submit">הוסף מוצר</button>
        <div class="muted">טיפ: אם מעלים קובץ ל־<code>public/images</code>, מספיק לכתוב את שמו (למשל <code>cookie.jpg</code>).</div>
      </form>
    </section>

    <section class="panel">
      <h2>מוצרים קיימים</h2>
      <div id="products" class="admin-list"></div>
    </section>

    <section class="panel">
      <h2>פעילות אחרונה</h2>
      <div class="muted">מוצג חדש←ישן.</div>
      <div id="activity" class="admin-list"></div>
    </section>
  </div>

  <script>
    async function setupAuthButtons() {
      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout');
      let loggedIn = false;
      try { const r = await fetch('/api/session'); loggedIn = r.ok; } catch {}
      loginLink.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }
    setupAuthButtons();
    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); }
      finally { location.href = 'login.html'; }
    };

    const productsBox = document.getElementById('products');
    async function loadProducts(){
      productsBox.innerHTML = 'טוען...';
      const res = await fetch('/api/admin/products');
      if (res.status === 401) return location.href = 'login.html';
      if (res.status === 403) { productsBox.textContent = 'Admin only'; return; }
      const items = await res.json();
      productsBox.innerHTML = '';
      for (const p of items){
        const row = document.createElement('div');
        row.className = 'admin-row';
        row.innerHTML = `
          <img src="${p.image.startsWith('http') ? p.image : '/images/' + p.image}" alt="${p.title}">
          <div>
            <div><strong>${p.title}</strong></div>
            <div class="muted">${p.id}</div>
          </div>
          <button data-id="${p.id}">מחק</button>
        `;
        row.querySelector('button').onclick = async () => {
          if (!confirm('למחוק את "'+p.title+'"?')) return;
          const del = await fetch('/api/admin/products/' + encodeURIComponent(p.id), { method:'DELETE' });
          if (!del.ok){
            const j = await del.json().catch(() => ({}));
            alert(j.error || 'מחיקה נכשלה');
          }
          await loadProducts(); await loadActivity();
        };
        productsBox.appendChild(row);
      }
    }

    const addForm = document.getElementById('add-form');
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(addForm);
      const payload = {
        title: (fd.get('title') || '').trim(),
        description: (fd.get('description') || '').trim(),
        image: (fd.get('image') || '').trim()
      };
      if (!payload.title || !payload.image) return alert('יש למלא כותרת ותמונה');
      const res = await fetch('/api/admin/products', {
        method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (res.status === 401) return location.href = 'login.html';
      if (res.status === 403) return alert('Admin only');
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok) return alert(j.error || 'הוספה נכשלה');
      addForm.reset(); await loadProducts(); await loadActivity(); alert('המוצר נוסף בהצלחה!');
    });

    const actBox = document.getElementById('activity');
    async function loadActivity(){
      actBox.innerHTML = 'טוען...';
      const res = await fetch('/api/admin/activity');
      if (res.status === 403) { actBox.textContent = 'אין הרשאת מנהל'; return; }
      if (!res.ok) { actBox.textContent = 'שגיאה'; return; }
      const rows = await res.json();
      actBox.innerHTML = '';
      for (const r of rows){
        const div = document.createElement('div'); div.className = 'admin-row';
        const when = r.datetime ? new Date(r.datetime).toLocaleString('he-IL') : '';
        div.innerHTML = `<div style="grid-column:1 / span 3;"><strong>${r.type}</strong> <span class="muted">— ${when} — ${r.username || ''}</span></div>`;
        actBox.appendChild(div);
      }
    }

    loadProducts(); loadActivity();
  </script>
</body>
</html>
