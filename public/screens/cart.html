<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title data-page="cart">סל הקניות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="/assets/translations.js"></script>
</head>
<body>
  <nav>
    <a href="store.html" data-key="store">חנות</a>
    <a href="cart.html" data-key="cart">סל הקניות</a>
    <a href="checkout.html" data-key="checkout">תשלום</a>
    <a href="myitems.html" data-key="myPurchases">הרכישות שלי</a>
    <a id="login-link" href="login.html" data-key="login">התחברות</a>
    <button id="logout" style="display:none" data-key="logout">התנתקות</button>
    <a href="admin.html" data-key="admin">ניהול</a>
    <button id="theme-toggle">🌙 מצב כהה</button>
    <button id="language-toggle">🌐 English</button>
  </nav>

  <h1 data-key="pageTitle.cart">סל הקניות</h1>
  <div id="items" class="cart-list"></div>

  <script>
    // טעינת נושא ושפה מהlocalStorage
    function loadUserPreferences() {
      const theme = localStorage.getItem('theme') || 'light';
      const language = localStorage.getItem('language') || 'he';
      
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
      }
      
      window.updateLanguage();
    }

    // ניהול נושא
    function setupThemeToggle() {
      const themeToggle = document.getElementById('theme-toggle');
      themeToggle.addEventListener('click', () => {
        const currentTheme = localStorage.getItem('theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        localStorage.setItem('theme', newTheme);
        document.body.classList.toggle('dark-theme', newTheme === 'dark');
        
        themeToggle.textContent = newTheme === 'dark' ? 
          window.Translations.get('themeToggleLight') : 
          window.Translations.get('themeToggleDark');
      });
    }

    // ניהול שפה
    function setupLanguageToggle() {
      const languageToggle = document.getElementById('language-toggle');
      languageToggle.addEventListener('click', window.toggleLanguage);
    }

    // ניווט דינמי
    async function setupAuthButtons() {
      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout');
      const adminLink = document.querySelector('a[href="admin.html"]');
      
      let loggedIn = false;
      let username = null;
      
      try { 
        const r = await fetch('/api/session'); 
        if (r.ok) {
          loggedIn = true;
          const data = await r.json();
          username = data.username;
        }
      } catch {}
      
      loginLink.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
      
      // הצגת כפתור ניהול רק למשתמש admin
      if (adminLink) {
        adminLink.style.display = (username === 'admin') ? '' : 'none';
      }
    }

    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); }
      finally { location.href = 'login.html'; }
    };

    let products = [];
    async function loadProducts() {
      const res = await fetch('/api/products');
      products = await res.json();
    }

    async function loadCart() {
      const res = await fetch('/api/cart');
      if (res.status === 401) return location.href = 'login.html';
      const quantities = await res.json();
      const container = document.getElementById('items');
      container.innerHTML = '';
      
      const itemsArray = Object.entries(quantities);
      if (itemsArray.length === 0) {
        container.innerHTML = `<p class="empty" data-key="cartEmpty">${window.Translations.get('cartEmpty')}</p>`;
        return;
      }
      
      for (const [id, quantity] of itemsArray) {
        const p = products.find(x => String(x.id) === String(id));
        if (!p) continue;
        
        const row = document.createElement('div');
        row.className = 'cart-item';
        
        // שם המוצר מתורגם
        const productName = window.Translations.getProduct(p.id) || p.title;
        
        row.innerHTML = `
          <div class="left">
            <img src="/images/${p.image}" alt="${productName}">
            <div class="cart-item-info">
              <h3>${productName}</h3>
              <div class="quantity-info">
                <span data-key="quantity">${window.Translations.get('quantity')}</span>: ${quantity}
              </div>
              <div class="quantity-controls">
                <button class="quantity-btn minus" data-id="${p.id}">-</button>
                <span class="quantity-display">${quantity}</span>
                <button class="quantity-btn plus" data-id="${p.id}">+</button>
              </div>
            </div>
          </div>
          <button class="remove" data-id="${p.id}" data-key="removeAll">${window.Translations.get('removeAll')}</button>
        `;
        container.appendChild(row);
      }
    }

    // ניהול אירועי סל הקניות
    document.getElementById('items').addEventListener('click', async (e) => {
      const btn = e.target.closest('.remove');
      const plusBtn = e.target.closest('.plus');
      const minusBtn = e.target.closest('.minus');
      
      if (btn) {
        // הסרת כל המוצר
        const id = btn.getAttribute('data-id');
        const del = await fetch(`/api/cart/${encodeURIComponent(id)}`, { method: 'DELETE' });
        if (del.ok) {
          loadCart();
        } else {
          let j = {}; 
          try { j = await del.json(); } catch {}
          alert(j.error || window.Translations.get('errorRemoving'));
        }
      } else if (plusBtn) {
        // הוספת יחידה
        const id = plusBtn.getAttribute('data-id');
        const add = await fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: id })
        });
        if (add.ok) {
          loadCart();
        } else {
          let j = {}; 
          try { j = await add.json(); } catch {}
          alert(j.error || window.Translations.get('errorAdding'));
        }
      } else if (minusBtn) {
        // הפחתת יחידה
        const id = minusBtn.getAttribute('data-id');
        const del = await fetch(`/api/cart/${encodeURIComponent(id)}`, { method: 'DELETE' });
        if (del.ok) {
          loadCart();
        } else {
          let j = {}; 
          try { j = await del.json(); } catch {}
          alert(j.error || window.Translations.get('errorRemoving'));
        }
      }
    });

    // האזנה לשינוי שפה
    window.addEventListener('languageChanged', () => {
      loadCart(); // טעינה מחדש של הסל עם התרגומים החדשים
    });

    // אתחול
    (async () => {
      loadUserPreferences();
      setupThemeToggle();
      setupLanguageToggle();
      setupAuthButtons();
      await loadProducts();
      await loadCart();
    })();
  </script>
</body>
</html>